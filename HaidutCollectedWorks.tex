\documentclass[symmetric,notoc,nobib,nols]{tufte-book}

% ——————— PACKAGES ———————
\usepackage[USenglish]{babel}
\usepackage[maxlevel=3]{csquotes}
\usepackage[nopatch=footnote]{microtype} 
\usepackage{fontspec}
\usepackage{xparse}
\usepackage{lua-ul}
\usepackage{graphicx}
\usepackage{adjustbox}
\usepackage{xurl}
\usepackage[shortcuts]{extdash}
\usepackage{hyperref}
\usepackage{fancyhdr}
\usepackage{changepage}
\usepackage{makeidx}
\usepackage{titlesec}
\usepackage[most]{tcolorbox}
\usepackage{chemfig}
\usepackage{luacode}
\usepackage{luacolor}
\usepackage{tikz}
\usetikzlibrary{calc}
\usepackage{chngcntr}
\usepackage{etoolbox}
\usepackage{truncate}

% ——————— FONTS & MICROTYPOGRAPHY ———————
\renewcommand{\smallcapsspacing}[1]{\textls[50]{#1}}
\renewcommand{\allcapsspacing}[1]{\textls[200]{#1}}

% ——————— EB GARAMOND FONT FAMILY ———————
\setmainfont{EBGaramond}[
    Path = Fonts/EB_Garamond/,
    Extension = .ttf,
    UprightFont = EBGaramond-Regular,
    BoldFont = EBGaramond-Bold,
    ItalicFont = EBGaramond-Italic,
    BoldItalicFont = EBGaramond-BoldItalic,
    FontFace = {m}{n}{EBGaramond-Medium},
    FontFace = {m}{it}{EBGaramond-MediumItalic},
    FontFace = {sb}{n}{EBGaramond-SemiBold},
    FontFace = {sb}{it}{EBGaramond-SemiBoldItalic},
    FontFace = {eb}{n}{EBGaramond-ExtraBold},
    FontFace = {eb}{it}{EBGaramond-ExtraBoldItalic},
    Numbers={Proportional} 
]

% ——————— OPEN SANS FONT FAMILY ——————— 
\setsansfont{OpenSans}[
    Path = Fonts/Open_Sans/,
    Extension = .ttf,
    UprightFont = OpenSans-Regular,
    BoldFont = OpenSans-Bold,
    ItalicFont = OpenSans-Italic,
    BoldItalicFont = OpenSans-BoldItalic,
    FontFace = {l}{n}{OpenSans-Light},
    FontFace = {l}{it}{OpenSans-LightItalic},
    FontFace = {m}{n}{OpenSans-Medium},
    FontFace = {m}{it}{OpenSans-MediumItalic},
    FontFace = {sb}{n}{OpenSans-SemiBold},
    FontFace = {sb}{it}{OpenSans-SemiBoldItalic},
    FontFace = {eb}{n}{OpenSans-ExtraBold},
    FontFace = {eb}{it}{OpenSans-ExtraBoldItalic}
]

% ——————— ARTICLE LOADING ———————
\newcommand{\coveryear}{}
\newcommand{\covervolume}{}

\begin{luacode*}
local year = nil
local args = arg or {}

if args[2] then
year = tonumber(args[2])
  if not year or year < 2013 or year > 2024 then
    os.exit(1)
  end
else
  os.exit(1)
end

function include_articles(directory)
  local files = {}
  for file in lfs.dir(directory) do
    if string.match(file, "%.tex$") then
      table.insert(files, file)
    end
  end
  table.sort(files)
  for _, file in ipairs(files) do
    tex.sprint("\\input{" .. directory .. "/" .. file .. "}")
    tex.sprint("\\clearpage")  
  end
end

function load_articles()
  include_articles("Articles/" .. year)
end

function int_to_roman(num)
  local values = {1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1}
  local numerals = {"M", "CM", "D", "CD", "C", "XC", "L", "XL", "X", "IX", "V", "IV", "I"}
  local result = ""
  
  for i = 1, #values do
    while num >= values[i] do
      result = result .. numerals[i]
      num = num - values[i]
    end
  end
  
  return result
end

function set_cover_year()
  local volume_num = year - 2012
  local roman_volume = int_to_roman(volume_num)
  
  tex.sprint("\\renewcommand{\\coveryear}{" .. year .. "}")
  tex.sprint("\\renewcommand{\\covervolume}{VOLUME~" .. roman_volume .. "}")
end

function load_bibliography()
  tex.sprint("\\addbibresource{Bibliographies/" .. year .. ".bib}")
end

function get_pdf_title()
  local volume_num = year - 2012
  local roman_volume = int_to_roman(volume_num)
  tex.sprint("Collected Works, Volume " .. roman_volume .. " (" .. year .. ")")
end
\end{luacode*}

% ——————— BIBLIOGRAPHY ———————
\usepackage[backend=biber,style=numeric-comp,sorting=none,citetracker=true]{biblatex}
\directlua{load_bibliography()}
\renewcommand{\bibfont}{\footnotesize\sffamily}
\setlength{\bibitemsep}{0.75\baselineskip}
\setlength{\bibhang}{1.5em}
\DeclareFieldFormat{url}{\href{#1}{\path{#1}}}
\defbibheading{subbibliography}[References]{\subsection*{\normalfont\bfseries\sffamily #1}}
\renewcommand*{\biburlsetup}{%
  \urlstyle{tt}%
  \Urlmuskip=0mu plus 1mu
}

\setlength\bibitemsep{0.5\baselineskip}

% ——————— PAGE LAYOUT ———————
\makeatletter
\setboolean{@tufte@justified}{true}
\makeatother
\geometry{textheight=46\baselineskip}

\makeatletter
\@addtoreset{figure}{chapter}
\pretocmd{\chapter}{\setcounter{figure}{0}}{}{}
\makeatother

\setlength{\headheight}{22pt}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% ——————— PARAGRAPH STYLE ———————
\makeatletter
\renewcommand{\@tufte@reset@par}{%
  \setlength{\RaggedRightParindent}{1.0pc}%
  \setlength{\JustifyingParindent}{1.0pc}%
  \setlength{\parindent}{1pc}%
  \setlength{\parskip}{0pt}%
}
\@tufte@reset@par

\renewcommand{\@tufte@margin@par}{%
  \setlength{\RaggedRightParindent}{0.5pc}%
  \setlength{\JustifyingParindent}{0.5pc}%
  \setlength{\parindent}{0.5pc}%
  \setlength{\parskip}{0pt}%
}
\makeatother

% ——————— INDEXING ———————
\makeindex

\makeatletter
\renewenvironment{theindex}
 {%
 \small%
 \ifthenelse{\equal{\@tufte@class}{book}}%
 {\chapter{\indexname}}%
 {\section*{\indexname}}%
 \parskip0pt%
 \parindent0pt%
 \let\item\@idxitem%
 \begin{multicols}{2}%
 }
 {\end{multicols}%
 }
\makeatother

\newcommand{\smarttruncate}[2]{%
  \ifdim\widthof{#2} > #1\relax
    \truncate{#1}{#2}%
  \else
    #2%
  \fi
}

% ——————— TABLE OF CONTENTS CUSTOMIZATION ———————
\makeatletter
\renewcommand*\l@chapter[2]{%
  \ifnum \c@tocdepth >-1
    \addpenalty{-\@highpenalty}%
    \vskip 1.0em \@plus\p@ % Vertical space before the entry
    \begingroup
      \parindent \z@ % Set paragraph indentation to 0
      \begin{tabular}[t]{@{}p{\dimexpr\linewidth-\@pnumwidth}r@{}}
        \bfseries #1 & \makebox[\@pnumwidth][r]{#2} \\
      \end{tabular}\par
    \endgroup
    \penalty\@highpenalty
  \fi
}
\makeatother

% ——————— COLOR DEFINITIONS ———————
\definecolor{ArticleBlue}{HTML}{0071BC}
\definecolor{ArticleRed}{HTML}{E31C3D}

\definecolor{CoverBG}{HTML}{0F1419}
\definecolor{TitleColor}{HTML}{FFFFFF}
\definecolor{AccentGold}{HTML}{D4AF37}
\definecolor{SubtitleColor}{HTML}{B8BCC8}
\definecolor{LineColor}{HTML}{2A3441}
\definecolor{YearColor}{HTML}{1A202C}
\definecolor{MoleculeColor}{HTML}{8B9DC3}

% ——————— UNDERLINE CUSTOMIZATION ———————
\let\OriginalUnderLine\underLine
\renewcommand{\underLine}[2][]{%
  \OriginalUnderLine[color=black,#1]{#2}%
}

% ——————— GRAPHICS OPTIONS ———————
\graphicspath{{Images/}}

% ——————— HYPERLINKS ———————
\hypersetup{
    colorlinks=true,
    urlcolor=ArticleBlue,
    linkcolor=ArticleBlue,
    breaklinks=true,
    pdfauthor={Haidut},
    pdftitle={\directlua{get_pdf_title()}}
}

% ——————— CHAPTER STYLE ———————
\newcommand{\chapterrule}{\begin{fullwidth}\rule{\linewidth}{1pt}\end{fullwidth}}
\titleformat{\chapter}[display]
  {\normalfont\sffamily\huge\raggedright\setcounter{footnote}{0}\chapterrule\vspace{10pt}}
  {}
  {0pt}
  {\begin{fullwidth}}
  [\end{fullwidth}]
\titlespacing*{\chapter}{0pt}{-42pt}{15pt}

% ——————— ARTICLE METADATA ———————     
\ExplSyntaxOn
\NewDocumentCommand{\tags}{m}{
  \begin{fullwidth}
    \noindent{\sffamily\large\textbf{Haidut}}\par\vspace{1ex}
    \noindent{\sffamily\footnotesize Tags:~
      \clist_map_inline:nn { #1 } { \index{##1} }
      \clist_use:nn { #1 } { ,~ }
    }\par
  \end{fullwidth}
  \vspace{2.5ex}
}
\ExplSyntaxOff

% ——————— HEADER & FOOTER ———————
\newcommand{\truncateheader}[2]{%
  \truncate{#1}{\MakeTextUppercase{#2}}%
}

\newlength{\myfullwidth}
\setlength{\myfullwidth}{\dimexpr\textwidth+\marginparwidth+\marginparsep\relax}

\newcommand{\footerinfo}{}
\newcommand{\info}[1]{\renewcommand{\footerinfo}{#1}}

\newcommand{\myfooter}{%
  \parbox[t]{\myfullwidth}{%
    \rule{\linewidth}{1pt}\par\vspace{1pt}%
    \sffamily\textbf{RAY PEAT FORUM} \footerinfo\hfill\sffamily\thepage
  }%
}
\newcommand{\myfooterodd}{\myfooter}
\newcommand{\myfootereven}{%
  \makebox[0pt][r]{%
    \hspace*{\dimexpr\marginparwidth+\marginparsep\relax}%
    \myfooter
  }%
}

% ——————— MAIN DOCUMENT ———————
\begin{document}

\pagenumbering{gobble}

\directlua{set_cover_year()}
\input{Cover}
\clearpage

\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\sffamily\Large\allcapsspacing{CONTENTS}}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
  \fancyhead[RO]{{\sffamily\Huge\bfseries\allcapsspacing{CONTENTS}}}
}

\tableofcontents
\clearpage
\thispagestyle{empty}
\null
\clearpage

\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{{\sffamily\Large\allcapsspacing{ARTICLE}~|}~\sffamily\smallcaps{\truncate{0.85\linewidth}{\MakeTextUppercase{\leftmark}}}}
\fancyhead[RO]{\sffamily\smallcaps{\truncate{0.85\linewidth}{\MakeTextUppercase{\hfill\leftmark}}}~{\sffamily\Large|~\allcapsspacing{ARTICLE}}}
\fancyfoot[LO]{\myfooterodd} 
\fancyfoot[RE]{\myfootereven}
\fancyfoot[LE,RO,C]{}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
  \fancyhead[RO]{{\sffamily\Huge\bfseries\allcapsspacing{ARTICLE}}}
  \fancyfoot[LO]{\myfooterodd}%
  \fancyfoot[RE]{\myfootereven}%
  \fancyfoot[LE,RO,C]{}%
}

\pagenumbering{arabic}

\directlua{load_articles()}

\clearpage
\thispagestyle{empty}
\null
\clearpage

\pagestyle{empty}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyhead[LE,RO]{{\sffamily\Large\allcapsspacing{INDEX}}}

\fancypagestyle{plain}{%
  \fancyhf{}%
  \renewcommand{\headrulewidth}{0pt}%
  \renewcommand{\footrulewidth}{0pt}%
  \fancyhead[RO]{{\sffamily\Huge\bfseries\allcapsspacing{INDEX}}}
}
\printindex
 
\end{document}